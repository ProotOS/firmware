name: Build Firmware

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    name: Build (${{ matrix.board.name }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        board:
          - name: waveshare-s3-round
            target: esp32s3
            chip: ESP32-S3
            sdkconfig_defaults: sdkconfig.defaults;sdkconfig.defaults.esp32s3
          - name: waveshare-c6-169
            target: esp32c6
            chip: ESP32-C6
            sdkconfig_defaults: sdkconfig.defaults;sdkconfig.defaults.esp32c6

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build with ESP-IDF
        uses: espressif/esp-idf-ci-action@v1
        with:
          esp_idf_version: v5.2.1
          target: ${{ matrix.board.target }}
          path: .
          command: >
            idf.py
            -DSDKCONFIG_DEFAULTS="${{ matrix.board.sdkconfig_defaults }}"
            -DSDKCONFIG=sdkconfig.${{ matrix.board.name }}
            build

      - name: Collect firmware artifacts
        run: |
          BOARD="${{ matrix.board.name }}"
          TARGET="${{ matrix.board.target }}"
          BUILD_DIR="build"
          OUT_DIR="firmware/${BOARD}"
          mkdir -p "${OUT_DIR}"

          # Copy the binaries needed to flash a complete image
          cp "${BUILD_DIR}/prootos-firmware.bin"            "${OUT_DIR}/app.bin"
          cp "${BUILD_DIR}/bootloader/bootloader.bin"       "${OUT_DIR}/bootloader.bin"
          cp "${BUILD_DIR}/partition_table/partition-table.bin" "${OUT_DIR}/partition-table.bin"

          # Copy merged flash args so offsets are captured alongside binaries
          cp "${BUILD_DIR}/flash_args"                      "${OUT_DIR}/flash_args.txt"

          # Read flash offsets from the build system
          APP_OFFSET=$(python3 -c "
          import json, pathlib
          meta = json.loads(pathlib.Path('${BUILD_DIR}/project_description.json').read_text())
          print(hex(meta['app_flash_offset']))
          ")

          BOOTLOADER_OFFSET=0x0
          PT_OFFSET=0x8000

          # esptool-js manifest (https://github.com/espressif/esptool-js)
          cat > "${OUT_DIR}/manifest.json" <<EOF
          {
            "name": "Prootos Firmware - ${BOARD}",
            "version": "${GITHUB_SHA::8}",
            "builds": [
              {
                "chipFamily": "${{ matrix.board.chip }}",
                "parts": [
                  {
                    "path": "bootloader.bin",
                    "offset": ${BOOTLOADER_OFFSET}
                  },
                  {
                    "path": "partition-table.bin",
                    "offset": ${PT_OFFSET}
                  },
                  {
                    "path": "app.bin",
                    "offset": ${APP_OFFSET}
                  }
                ]
              }
            ]
          }
          EOF

          # Trim leading whitespace from heredoc
          python3 -c "
          import json, pathlib
          p = pathlib.Path('${OUT_DIR}/manifest.json')
          p.write_text(json.dumps(json.loads(p.read_text()), indent=2) + '\n')
          "

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.board.name }}-${{ github.sha }}
          path: firmware/${{ matrix.board.name }}/
          if-no-files-found: error

  # Combine per-board manifests into a single top-level manifest
  manifest:
    name: Build combined manifest
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download all firmware artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: firmware-*
          path: firmware/
          merge-multiple: false

      - name: Build combined manifest
        run: |
          python3 - <<'PYEOF'
          import json, pathlib, os, glob

          # artifacts land at firmware/<artifact-name>/<board-name>/manifest.json
          builds = []
          for manifest_path in sorted(glob.glob("firmware/*/*/manifest.json")):
              p = pathlib.Path(manifest_path)
              board_name = p.parent.name          # e.g. waveshare-s3-round
              data = json.loads(p.read_text())
              for build in data["builds"]:
                  for part in build["parts"]:
                      # Make paths relative to the combined manifest location
                      part["path"] = f"{board_name}/{part['path']}"
                  builds.append(build)

          combined = {
              "name": "Prootos Firmware",
              "version": os.environ.get("GITHUB_SHA", "dev")[:8],
              "builds": builds,
          }

          out = pathlib.Path("firmware/manifest.json")
          out.write_text(json.dumps(combined, indent=2) + "\n")
          print(out.read_text())
          PYEOF

      - name: Upload combined manifest
        uses: actions/upload-artifact@v4
        with:
          name: firmware-manifest-${{ github.sha }}
          path: firmware/
          if-no-files-found: error
