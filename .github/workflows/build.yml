name: Build Firmware

on:
  push:
    branches: [main, master]
    tags: ["v*"]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    name: Build (${{ matrix.board.name }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        board:
          - name: waveshare-s3-round
            target: esp32s3
            chip: ESP32-S3
            sdkconfig_defaults: sdkconfig.defaults;sdkconfig.defaults.esp32s3
          - name: waveshare-c6-169
            target: esp32c6
            chip: ESP32-C6
            sdkconfig_defaults: sdkconfig.defaults;sdkconfig.defaults.esp32c6

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # dependencies.lock is target-specific; delete it so IDF regenerates
      # a fresh one for this target rather than rejecting a mismatched one.
      - name: Remove stale dependencies.lock
        run: rm -f dependencies.lock

      - name: Build with ESP-IDF
        uses: espressif/esp-idf-ci-action@v1
        with:
          esp_idf_version: v5.2.1
          target: ${{ matrix.board.target }}
          path: .
          command: >
            idf.py
            -DSDKCONFIG_DEFAULTS="${{ matrix.board.sdkconfig_defaults }}"
            -DSDKCONFIG=sdkconfig.${{ matrix.board.name }}
            build

      - name: Collect firmware artifacts
        env:
          BOARD: ${{ matrix.board.name }}
          CHIP: ${{ matrix.board.chip }}
          VERSION: ${{ github.ref_type == 'tag' && github.ref_name || github.sha }}
        run: |
          BUILD_DIR="build"
          OUT_DIR="firmware/${BOARD}"
          export BUILD_DIR OUT_DIR
          mkdir -p "${OUT_DIR}"

          # Copy binaries with board-slug prefix for unambiguous release attachment
          cp "${BUILD_DIR}/prootos-firmware.bin"                "${OUT_DIR}/${BOARD}-app.bin"
          cp "${BUILD_DIR}/bootloader/bootloader.bin"           "${OUT_DIR}/${BOARD}-bootloader.bin"
          cp "${BUILD_DIR}/partition_table/partition-table.bin" "${OUT_DIR}/${BOARD}-partition-table.bin"
          cp "${BUILD_DIR}/flash_args"                          "${OUT_DIR}/${BOARD}-flash_args.txt"

          # Parse flash_args for offsets — format is "<offset> <path>" per line,
          # with a leading options line that has no offset (starts with '--').
          python3 - <<'PYEOF'
          import pathlib, json, os

          build_dir = pathlib.Path(os.environ["BUILD_DIR"])
          out_dir   = pathlib.Path(os.environ["OUT_DIR"])
          board     = os.environ["BOARD"]
          chip      = os.environ["CHIP"]
          version   = os.environ["VERSION"]

          parts = []
          for line in (build_dir / "flash_args").read_text().splitlines():
              line = line.strip()
              if not line or line.startswith("--"):
                  continue
              offset_str, rel_path = line.split(None, 1)
              offset = int(offset_str, 16)
              basename = pathlib.Path(rel_path).name

              if basename == "bootloader.bin":
                  dest = f"{board}-bootloader.bin"
              elif basename == "partition-table.bin":
                  dest = f"{board}-partition-table.bin"
              elif basename.endswith(".bin") and "srmodel" not in basename and "ota_data" not in basename:
                  dest = f"{board}-app.bin"
              else:
                  # Skip models / OTA data — too large for esptool-js initial flash
                  continue

              parts.append({"path": dest, "offset": offset})

          parts.sort(key=lambda p: p["offset"])

          manifest = {
              "name": f"Prootos Firmware - {board}",
              "version": version,
              "builds": [{"chipFamily": chip, "parts": parts}],
          }
          (out_dir / f"{board}-manifest.json").write_text(json.dumps(manifest, indent=2) + "\n")
          print(json.dumps(manifest, indent=2))
          PYEOF

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.board.name }}
          path: firmware/${{ matrix.board.name }}/
          if-no-files-found: error

  release:
    name: Create release
    runs-on: ubuntu-latest
    needs: build
    # Run on tags only; the build job always runs (for branch CI too)
    if: github.ref_type == 'tag'
    permissions:
      contents: write  # create GitHub release
      pages: write     # upload Pages artifact
      id-token: write  # required by actions/deploy-pages OIDC auth
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      - name: Download all firmware artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: firmware-*
          path: firmware/
          merge-multiple: false

      - name: Build combined manifest
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          python3 - <<'PYEOF'
          import json, pathlib, os, glob

          version = os.environ["VERSION"]

          # Per-board manifests land at firmware/<artifact-name>/<board>-manifest.json
          # All binaries use board-slug prefixes so paths are unambiguous when flat.
          builds = []
          for manifest_path in sorted(glob.glob("firmware/*/*-manifest.json")):
              data = json.loads(pathlib.Path(manifest_path).read_text())
              builds.extend(data["builds"])

          combined = {
              "name": "Prootos Firmware",
              "version": version,
              "builds": builds,
          }

          out = pathlib.Path("firmware/manifest.json")
          out.write_text(json.dumps(combined, indent=2) + "\n")
          print(out.read_text())
          PYEOF

      - name: Flatten release files
        run: |
          mkdir -p release/
          # Copy all board-prefixed bins and per-board manifests into a flat dir
          find firmware/ -name '*.bin' -o -name '*-manifest.json' -o -name '*-flash_args.txt' \
            | xargs -I{} cp {} release/
          # Add the combined manifest
          cp firmware/manifest.json release/manifest.json

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          files: release/*

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # The actions/deploy-pages method replaces the entire site on each
          # deploy, so nest firmware files under a firmware/ subdirectory inside
          # the artifact so your site root can still hold other content.
          path: release/

      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4
